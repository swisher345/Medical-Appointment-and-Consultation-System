<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>医生资料管理</title>
  <style>
    body {
      font-family: "Microsoft Yahei", sans-serif;
      margin: 0;
      background: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    h2 {
      color: #2c3e50;
      font-size: 24px;
      font-weight: 600;
    }
    .toolbar {
      display: flex;
      gap: 10px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
    }
    .btn-primary {
      background-color: #3498db;
      color: white;
    }
    .btn-primary:hover {
      background-color: #2980b9;
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-outline {
      background-color: transparent;
      border: 1px solid #ddd;
      color: #333;
    }
    .btn-outline:hover {
      background-color: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      overflow: hidden;
    }
    .card-header {
      padding: 16px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title {
      font-size: 18px;
      font-weight: 500;
    }
    .card-body {
      padding: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
    }
    th {
      background-color: #3498db;
      color: white;
      font-weight: 500;
      border-bottom: 2px solid #2980b9;
    }
    td {
      border-bottom: 1px solid #eee;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    tr:hover {
      background-color: #f0f7fd;
      transition: background-color 0.2s;
    }
    .actions {
      display: flex;
      gap: 8px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      outline: none;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      border-color: #3498db;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 24px;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
    }
    .close {
      color: #aaa;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover, .close:focus {
      color: #333;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }
    .doctor-profile {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .doctor-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      color: white;
    }
    .doctor-info {
      flex: 1;
    }
    .doctor-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .doctor-title {
      color: #666;
      margin-bottom: 4px;
    }
    .doctor-specialty {
      color: #666;
      margin-bottom: 8px;
    }
    .doctor-schedule {
      margin-top: 12px;
    }
    .doctor-details h3 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .doctor-details p {
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 4px;
      color: white;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .notification-success {
      background-color: #2ecc71;
    }
    .notification-error {
      background-color: #e74c3c;
    }
    .notification.show {
      opacity: 1;
    }
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab {
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom-color: #3498db;
      color: #3498db;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>医生资料管理系统</h2>
      <div class="toolbar">
        <button id="addDoctorBtn" class="btn btn-primary">
          <i class="fa fa-plus mr-1"></i>添加医生
        </button>
      </div>
    </div>

    <div class="tab-navigation">
      <div class="tab active" data-tab="list">医生列表</div>
      <div class="tab" data-tab="profile">医生详情</div>
    </div>

    <div class="tab-content active" id="list-tab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">医生列表</div>
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索医生...">
          </div>
        </div>
        <div class="card-body">
          <table>
            <thead>
              <tr>
                <th>医生ID</th>
                <th>姓名</th>
                <th>职称</th>
                <th>专长</th>
                <th>本周工作时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="doctorsTable">
              <!-- 医生数据将通过JavaScript动态加载 -->
            </tbody>
          </table>
<!--          分页容器-->
          <div id="paginationControls" style="margin-top: 10px; text-align: center;"></div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="profile-tab">
      <div class="card">
        <div class="card-header">
          <div class="card-title">医生详情</div>
          <button id="backToListBtn" class="btn btn-outline">
            <i class="fa fa-arrow-left mr-1"></i>返回列表
          </button>
        </div>
        <div class="card-body">
          <div id="doctorProfile" class="doctor-profile">
            <!-- 头像将通过JS动态生成 -->
          </div>

          <div class="doctor-details">
            <h3>医生简介</h3>
            <p><strong>从业时间：</strong><span id="profileExperience"></span></p>
            <p id="profileDescription">
              张三医生是心血管领域的专家，拥有20年临床经验，擅长冠心病、心力衰竭和心律失常的诊断与治疗。
              他在国内外医学期刊发表论文30余篇，主持多项科研项目，曾获"优秀医师"称号。
            </p>

            <h3>职称</h3>
            <p id="profileProfessionalTitle">
              中国医师协会心血管内科分会会员<br>
              美国心脏病学会（ACC）会员<br>
              心血管疾病介入诊疗资质
            </p>
          </div>

          <div class="actions mt-4">
            <button id="editProfileBtn" class="btn btn-primary">
              <i class="fa fa-edit mr-1"></i>编辑资料
            </button>
            <button id="deleteProfileBtn" class="btn btn-danger">
              <i class="fa fa-trash mr-1"></i>删除医生
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 添加/编辑医生模态框 -->
<div id="doctorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="modalTitle">添加医生</h3>
      <span class="close">&times;</span>
    </div>
    <form id="doctorForm">
      <input type="hidden" id="doctorId">
      <div class="modal-body">
        <div class="form-group">
          <label for="doctorName">医生姓名</label>
          <input type="text" id="doctorName" required>
        </div>
        <div class="form-group">
          <label for="doctorTitle">职称</label>
          <select id="doctorTitle">
            <option value="主任医师">主任医师</option>
            <option value="副主任医师">副主任医师</option>
            <option value="主治医师">主治医师</option>
            <option value="住院医师">住院医师</option>
            <option value="实习医师">实习医师</option>
          </select>
        </div>

        <!-- ✅ 新增：所属科室 -->
        <div class="form-group">
          <label for="doctorDepartment">所属科室</label>
          <select id="doctorDepartment" required>
            <!-- 后续由 JS 动态填充 -->
          </select>
        </div>

        <div class="form-group">
          <label for="doctorSpecialty">专长</label>
          <input type="text" id="doctorSpecialty" required>
        </div>
<!--        工作时间更改为从业年限-->
        <div class="form-group">
          <label for="doctorExperience">从业年限（年）</label>
          <input type="number" id="doctorExperience" min="0" required>
        </div>
        <div class="form-group">
          <label for="doctorDescription">医生简介</label>
          <textarea id="doctorDescription" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label for="doctorProfessionalTitle">荣誉</label>
          <textarea id="doctorProfessionalTitle" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="cancelBtn" class="btn btn-outline">取消</button>
        <button type="submit" id="saveBtn" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</div>


  <!-- 通知提示 -->
  <div id="notification" class="notification"></div>

  <script>
    // DOM元素
    const doctorsTable = document.getElementById('doctorsTable');
    const addDoctorBtn = document.getElementById('addDoctorBtn');
    const doctorModal = document.getElementById('doctorModal');
    const closeModal = document.querySelector('.close');
    const cancelBtn = document.getElementById('cancelBtn');
    const doctorForm = document.getElementById('doctorForm');
    const modalTitle = document.getElementById('modalTitle');
    const doctorId = document.getElementById('doctorId');
    const searchInput = document.getElementById('searchInput');
    const notification = document.getElementById('notification');
    const backToListBtn = document.getElementById('backToListBtn');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const deleteProfileBtn = document.getElementById('deleteProfileBtn');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    // 当前选中的医生ID
    let selectedDoctorId = null;
let sampleDoctors = []; // 初始化为空
let currentPage = 1;
const pageSize = 5;  // 每页显示5条


function loadDoctors(page = 1) {
  const keyword = searchInput.value.trim();  // 读取搜索框内容

  fetch(`/api/doctors?page=${page}&pageSize=${pageSize}&keyword=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(result => {
      if (result.error) {
        showNotification(result.error, 'error');
        return;
      }
      sampleDoctors = result.data;
      totalDoctors = result.total;
      currentPage = result.page;

      renderDoctorsTable();
      renderPaginationControls();
      showNotification('医生数据加载成功', 'success');
    })
    .catch(err => {
      console.error('加载失败:', err);
      showNotification('加载医生数据失败', 'error');
    });
}


    // 初始化
    function init() {
      loadDoctors(1);
      setupEventListeners();
    }

    // 设置事件监听器
    function setupEventListeners() {
      // 添加医生按钮
      addDoctorBtn.addEventListener('click', () => {
        modalTitle.textContent = '添加医生';
        doctorId.value = '';
        doctorForm.reset();
        loadDepartments();
        doctorModal.style.display = 'block';
      });

      // 关闭模态框
      closeModal.addEventListener('click', () => {
        doctorModal.style.display = 'none';
      });

      // 取消按钮
      cancelBtn.addEventListener('click', () => {
        doctorModal.style.display = 'none';
      });

      // 点击模态框外部关闭
      window.addEventListener('click', (event) => {
        if (event.target === doctorModal) {
          doctorModal.style.display = 'none';
        }
      });

      // 表单提交
      doctorForm.addEventListener('submit', (event) => {
        event.preventDefault();

       //删除就业时间，更改为从业年限
        const formData = {
          id: doctorId.value || generateId(),
          name: document.getElementById('doctorName').value,
          title: document.getElementById('doctorTitle').value,
          department: document.getElementById('doctorDepartment').value,
          specialty: document.getElementById('doctorSpecialty').value,
          experience: document.getElementById('doctorExperience').value,  // ✅ 新增
          description: document.getElementById('doctorDescription').value,
          professionalTitle: document.getElementById('doctorProfessionalTitle').value
        };



        if (doctorId.value) {
          // 更新医生
          updateDoctor(formData);
        } else {
          // 添加医生
          addDoctor(formData);
        }

        doctorModal.style.display = 'none';
      });

      // 搜索功能
      searchInput.addEventListener('input', function(e) {
        loadDoctors(1);  // 搜索时从第1页加载新数据
      });

      // 返回列表按钮
      backToListBtn.addEventListener('click', () => {
        switchTab('list');
      });

      // 编辑详情页医生资料
      editProfileBtn.addEventListener('click', () => {
        if (selectedDoctorId) {
          const doctor = sampleDoctors.find(d => d.id === selectedDoctorId);
          if (doctor) {
            fillFormWithDoctor(doctor);
            modalTitle.textContent = '编辑医生资料';
            doctorModal.style.display = 'block';
          }
        }
      });

      // 删除详情页医生
      deleteProfileBtn.addEventListener('click', () => {
        if (selectedDoctorId && confirm('确定要删除这位医生的资料吗？')) {
          deleteDoctor(selectedDoctorId);
          switchTab('list');
        }
      });

      // 标签页切换
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
    }

    function renderDoctorsTable() {
      doctorsTable.innerHTML = '';
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageDoctors = sampleDoctors.slice(start, end);

      sampleDoctors.forEach(doctor => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doctor.id}</td>
          <td>${doctor.name}</td>
          <td>${doctor.title}</td>
          <td>${doctor.specialty}</td>
          <td>${doctor.schedule}</td>
          <td class="actions">
            <button class="btn btn-primary" onclick="viewDoctor('${doctor.id}')">查看</button>
            <button class="btn btn-primary" onclick="editDoctor('${doctor.id}')">编辑</button>
            <button class="btn btn-danger" onclick="deleteDoctor('${doctor.id}')">删除</button>
          </td>
        `;
        doctorsTable.appendChild(tr);
      });

      renderPaginationControls();
    }

    function renderPaginationControls() {
      const totalPages = Math.ceil(totalDoctors / pageSize);
      const pagination = document.getElementById('paginationControls');
      if (!pagination) return;
      pagination.innerHTML = '';

      const pageNeighbors = 2;

      function createButton(page) {
        const btn = document.createElement('button');
        btn.textContent = page;
        btn.className = page === currentPage ? 'btn btn-primary' : 'btn btn-outline';
        btn.style.margin = '0 4px';
        btn.onclick = () => {
          if (page === currentPage) return;
          loadDoctors(page);
        };
        return btn;
      }

      pagination.appendChild(createButton(1));

      if (currentPage - pageNeighbors > 2) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.margin = '0 8px';
        pagination.appendChild(dots);
      }

      const startPage = Math.max(2, currentPage - pageNeighbors);
      const endPage = Math.min(totalPages - 1, currentPage + pageNeighbors);

      for (let i = startPage; i <= endPage; i++) {
        pagination.appendChild(createButton(i));
      }

      if (currentPage + pageNeighbors < totalPages - 1) {
        const dots = document.createElement('span');
        dots.textContent = '...';
        dots.style.margin = '0 8px';
        pagination.appendChild(dots);
      }

      if (totalPages > 1) {
        pagination.appendChild(createButton(totalPages));
      }
    }

    // 查看医生详情
    window.viewDoctor = function(id) {
      const doctor = sampleDoctors.find(d => d.id === id);
      if (doctor) {
        selectedDoctorId = id;

        // 生成随机背景色（确保足够亮以显示白色文字）
        const randomColor = '#' + Math.floor(Math.random() * 0x888888 + 0x888888).toString(16);

        // 提取姓名首字母作为头像内容
        const initials = doctor.name
          .split('')
          .map(char => char.trim())
          .filter(char => char.length > 0)
          .map(char => char.charAt(0))
          .join('') || '?';

        const avatarHtml = `
          <div class="doctor-avatar" style="background-color: ${randomColor}">
            <span>${initials}</span>
          </div>
        `;

        document.getElementById('doctorProfile').innerHTML = avatarHtml + `
          <div class="doctor-info">
            <div class="doctor-name" id="profileName">${doctor.name}</div>
            <div class="doctor-title" id="profileTitle">${doctor.title}</div>
            <div class="doctor-specialty" id="profileSpecialty">${doctor.specialty}</div>
            <div class="doctor-schedule">
              <strong>工作时间:</strong>
              <span id="profileSchedule">${doctor.schedule}</span>
            </div>
          </div>
        `;

        document.getElementById('profileExperience').textContent = doctor.experience;
        document.getElementById('profileDescription').textContent = doctor.description;
        document.getElementById('profileProfessionalTitle').textContent = doctor.professionalTitle;

        switchTab('profile');
      }
    }

    // 编辑医生
    window.editDoctor = function(id) {
      const doctor = sampleDoctors.find(d => d.id === id);
      if (doctor) {
        fillFormWithDoctor(doctor);
        modalTitle.textContent = '编辑医生资料';
        doctorModal.style.display = 'block';
      }
    }

    // 用医生数据填充表单
    function fillFormWithDoctor(doctor) {
      doctorId.value = doctor.id;
      document.getElementById('doctorName').value = doctor.name;
      document.getElementById('doctorTitle').value = doctor.title;
      document.getElementById('doctorSpecialty').value = doctor.specialty;
      document.getElementById('doctorExperience').value = parseInt(doctor.experience);  // ✅ 读取“5年”中的数字
      document.getElementById('doctorDescription').value = doctor.description;
      document.getElementById('doctorProfessionalTitle').value = doctor.professionalTitle;
    }

    // 添加医生
    function addDoctor(doctor) {
      fetch('/api/doctors', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(doctor)
      })
      .then(res => {
        if (res.ok) {
          showNotification('医生添加成功', 'success');
          loadDoctors();
        } else {
          return res.json().then(data => {
            showNotification('添加失败: ' + (data.error || '未知错误'), 'error');
          });
        }
      })
      .catch(error => {
        console.error('网络错误:', error);
        showNotification('请求失败，请检查网络连接或后端服务', 'error');
      });
    }

    // 更新医生
    function updateDoctor(doctor) {
      fetch('/api/doctors', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(doctor)
      })
        .then(response => {
          if (response.ok) {
            showNotification('医生资料更新成功', 'success');
            loadDoctors();  // 重新加载表格
          } else {
            return response.json().then(data => {
              showNotification('更新失败：' + (data.error || '未知错误'), 'error');
            });
          }
        })
        .catch(err => {
          console.error(err);
          showNotification('医生更新失败（网络错误）', 'error');
        });
    }

    // 删除医生
    window.deleteDoctor = function(id) {
      if (confirm('确定要删除这位医生的资料吗？')) {
        fetch(`/api/doctors/${id}`, {
          method: 'DELETE'
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            // 把错误信息也返回给后续处理
            return response.json().then(errData => Promise.reject(errData));
          }
        })
        .then(data => {
          // 删除成功
          const index = sampleDoctors.findIndex(d => d.id === id);
          if (index !== -1) {
            sampleDoctors.splice(index, 1);
            loadDoctors();
            if (selectedDoctorId === id) {
              selectedDoctorId = null;
              switchTab('list');
            }
            showNotification('医生资料已删除', 'success');
          }
        })
        .catch(err => {
          // 显示后端返回的错误消息
          const message = err.error || '删除医生失败';
          showNotification(message, 'error');
        });
      }
    }

    // 生成新ID
    function generateId() {
      const lastDoctor = sampleDoctors[sampleDoctors.length - 1];
      const lastId = lastDoctor ? parseInt(lastDoctor.id.substring(1)) : 0;
      return `D${lastId + 1}`;
    }

    //加载科室数据
    function loadDepartments() {
      fetch('/api/departments/list')  // 后端返回 JSON 格式科室列表
        .then(res => res.json())
        .then(data => {
          const select = document.getElementById('doctorDepartment');
          select.innerHTML = ''; // 清空旧内容
          data.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.name;
            select.appendChild(option);
          });
        });
    }

    // 过滤医生
    function filterDoctors(searchTerm) {
      doctorsTable.innerHTML = '';

      const filteredDoctors = sampleDoctors.filter(doctor =>
        doctor.name.toLowerCase().includes(searchTerm) ||
        doctor.title.toLowerCase().includes(searchTerm) ||
        doctor.specialty.toLowerCase().includes(searchTerm)
      );

      filteredDoctors.forEach(doctor => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doctor.id}</td>
          <td>${doctor.name}</td>
          <td>${doctor.title}</td>
          <td>${doctor.specialty}</td>
          <td>${doctor.schedule}</td>
          <td class="actions">
            <button class="btn btn-primary" onclick="viewDoctor('${doctor.id}')">
              <i class="fa fa-eye mr-1"></i>查看
            </button>
            <button class="btn btn-primary" onclick="editDoctor('${doctor.id}')">
              <i class="fa fa-edit mr-1"></i>编辑
            </button>
            <button class="btn btn-danger" onclick="deleteDoctor('${doctor.id}')">
              <i class="fa fa-trash mr-1"></i>删除
            </button>
          </td>
        `;
        doctorsTable.appendChild(tr);
      });
    }

    // 切换标签页
    function switchTab(tabName) {
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.getAttribute('data-tab') === tabName);
      });

      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === `${tabName}-tab`);
      });
    }

    // 显示通知
    function showNotification(message, type = 'success') {
      notification.textContent = message;
      notification.className = `notification notification-${type} show`;

      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // 初始化应用
    init();
  </script>
</body>
</html>