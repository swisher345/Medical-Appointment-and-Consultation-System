<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>挂号记录查询</title>
  <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet" />
  <style type="text/tailwindcss">
    @theme {
      --color-primary: #3b82f6;
      --color-secondary: #10b981;
      --color-dark: #1e293b;
      --color-light: #f8fafc;
      --font-inter: 'Inter', sans-serif;
    }
    body {
      font-family: var(--font-inter);
    }
    .table-header-blue {
      background-color: var(--color-primary);
      color: white;
    }
    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
        0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
  </style>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-7xl mx-auto">
    <!-- 标题和搜索框 -->
    <div
      class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4"
    >
      <h1 class="text-2xl font-bold">挂号记录查询</h1>
      <div class="relative w-full md:w-1/3">
        <input
          id="search-input"
          type="text"
          placeholder="输入患者姓名或挂号单号查询"
          class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
        />
        <i
          class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
        ></i>
      </div>
    </div>

    <!-- 数据统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">今日挂号</p>
            <h3 class="text-3xl font-bold mt-1">0</h3>
          </div>
          <div class="bg-blue-100 p-4 rounded-lg">
            <i class="fas fa-calendar-check text-primary text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">今日就诊</p>
            <h3 class="text-3xl font-bold mt-1">0</h3>
          </div>
          <div class="bg-green-100 p-4 rounded-lg">
            <i class="fas fa-user-md text-secondary text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">待就诊</p>
            <h3 class="text-3xl font-bold mt-1">0</h3>
          </div>
          <div class="bg-yellow-100 p-4 rounded-lg">
            <i
              class="fas fa-hourglass-half text-yellow-500 text-xl"
            ></i>
          </div>
        </div>
      </div>
    </div>

    <!-- 挂号记录表格 -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <table class="w-full border-collapse">
        <thead>
          <tr class="table-header-blue">
            <th class="p-4">挂号单号</th>
            <th class="p-4">患者姓名</th>
            <th class="p-4">科室</th>
            <th class="p-4">医生</th>
            <th class="p-4">挂号时间</th>
            <th class="p-4">就诊时间</th>
          </tr>
        </thead>
        <tbody id="registration-body">
          <!-- 动态数据填充 -->
        </tbody>
      </table>
    </div>

    <!-- 分页控件 -->
    <div
      class="mt-6 flex justify-center"
      id="pagination-controls"
    >
      <!-- 动态分页按钮 -->
    </div>
  </div>

  <script>
    const pageSize = 10; // 每页条数
    let currentPage = 1;
    let currentSearch = '';

    // 加载指定页数据
    function loadPage(page = 1, search = '') {
      currentPage = page;
      currentSearch = search.trim();

      // 如果有搜索词，带上查询参数（后端需要你实现搜索功能才支持，这里是示例）
      let url = `/api/registration-data?page=${page}&size=${pageSize}`;
      if (currentSearch) {
        url += `&search=${encodeURIComponent(currentSearch)}`;
      }

      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          // 更新统计卡片
          const cards = document.querySelectorAll('.text-3xl');
          if (cards.length >= 3) {
            cards[0].textContent = data.summary.today_appointments;
            cards[1].textContent = data.summary.today_treated;
            cards[2].textContent = data.summary.waiting;
          }

          // 更新表格
          const tbody = document.getElementById('registration-body');
          tbody.innerHTML = '';
          data.records.forEach((item) => {
            const tr = document.createElement('tr');
            tr.className =
              'border-b border-gray-200 hover:bg-gray-50 transition-colors';
            tr.innerHTML = `
              <td class="p-4">${item.registration_number}</td>
              <td class="p-4">${item.patient_name}</td>
              <td class="p-4">${item.department_name}</td>
              <td class="p-4">${item.doctor_name}</td>
              <td class="p-4">${item.appointment_time}</td>
              <td class="p-4">${item.treatment_time || '—'}</td>
            `;
            tbody.appendChild(tr);
          });

          // 渲染分页
          renderPagination(data.pagination.page, data.pagination.total_pages);
        })
        .catch((err) => {
          console.error('加载挂号数据失败:', err);
        });
    }

    // 渲染分页控件
    function renderPagination(currentPage, totalPages) {
      const container = document.getElementById('pagination-controls');
      container.innerHTML = '';

      // 上一页按钮
      const prevBtn = document.createElement('button');
      prevBtn.textContent = '«';
      prevBtn.disabled = currentPage === 1;
      prevBtn.className = prevBtn.disabled
        ? 'px-3 py-2 border bg-gray-200 text-gray-500 rounded-l'
        : 'px-3 py-2 border bg-white text-gray-700 hover:bg-gray-50 rounded-l cursor-pointer';
      prevBtn.onclick = () => loadPage(currentPage - 1, currentSearch);
      container.appendChild(prevBtn);

      // 页码按钮（最多7个）
      const maxPageButtons = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
      let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
      if (endPage - startPage + 1 < maxPageButtons) {
        startPage = Math.max(1, endPage - maxPageButtons + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className =
          i === currentPage
            ? 'px-4 py-2 border bg-primary text-white cursor-default'
            : 'px-4 py-2 border bg-white text-gray-700 hover:bg-gray-50 cursor-pointer';
        if (i !== currentPage) {
          pageBtn.onclick = () => loadPage(i, currentSearch);
        }
        container.appendChild(pageBtn);
      }

      // 下一页按钮
      const nextBtn = document.createElement('button');
      nextBtn.textContent = '»';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.className = nextBtn.disabled
        ? 'px-3 py-2 border bg-gray-200 text-gray-500 rounded-r'
        : 'px-3 py-2 border bg-white text-gray-700 hover:bg-gray-50 rounded-r cursor-pointer';
      nextBtn.onclick = () => loadPage(currentPage + 1, currentSearch);
      container.appendChild(nextBtn);
    }

    // 监听搜索框输入（简单防抖）
    let debounceTimer = null;
    document
      .getElementById('search-input')
      .addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          loadPage(1, e.target.value);
        }, 500);
      });

    // 页面加载时默认请求第一页
    document.addEventListener('DOMContentLoaded', () => {
      loadPage(1);
    });
  </script>
</body>
</html>
